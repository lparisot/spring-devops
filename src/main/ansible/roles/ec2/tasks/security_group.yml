---
- name: create security group
  ec2_group:
    name: "{{ project_name }}_{{ item.name }}_security_group"
    aws_access_key: "{{ ec2_access_key }}"
    aws_secret_key: "{{ ec2_secret_key }}"
    description: "{{ project_name }} {{ item.description }}"
    vpc_id: "{{ item.vpc_id }}"
    region: "{{ item.region }}"
    purge_rules: true
    rules: "{{ security_rules }}"
  with_items: "{{ ec2_groups }}"
  register: ec2_security_groups_temp
  tags: [ 'ec2' ]

- name: store result in ec2_security_groups
  set_fact:
    ec2_security_groups: "{{ ec2_security_groups | combine({group: ec2_security_groups_temp.results[0]}) }}"
  tags: [ 'ec2' ]